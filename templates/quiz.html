<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Take Quiz</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* CSS Reset to remove default browser margins/padding */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%; /* Ensures body takes full height of the viewport */
      overflow-x: hidden; /* Prevents horizontal scrollbars */
    }

    /* Basic layout for the quiz page */
    .quiz-layout {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      padding: 20px; /* This padding provides space around the content inside the layout */
      background-color: #333; /* Dark background for the page */
      color: #eee; /* Light text color for contrast */
      min-height: 100vh; /* Ensure it takes full viewport height */
      box-sizing: border-box; /* Includes padding and border in the element's total width and height */
    }

    .quiz-container {
      flex: 1;
      padding: 20px;
      background-color: #444; /* Slightly lighter dark background for the main quiz area */
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .sidebar {
      width: 250px;
      background-color: #555; /* Even lighter dark background for the sidebar */
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Styles for the question navigator grid */
    .question-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-top: 15px;
    }

    .question-btn {
      padding: 8px;
      font-size: 14px;
      background-color: #777; /* Default button color */
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .question-btn:hover {
      background-color: #888;
    }

    .question-btn.visited {
      background-color: #2196F3; /* Blue for visited questions */
    }

    .question-btn.answered {
      background-color: #4CAF50; /* Green for answered questions */
    }

    .question-btn.marked {
      background-color: #9C27B0; /* Purple for marked for review */
    }

    .question-btn.current {
      border: 2px solid #FFD700; /* Gold border for the current question */
      box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }

    /* Styles for general text and elements */
    h2, h4 {
      color: #FFD700; /* Gold color for headings */
    }

    p {
      line-height: 1.6;
    }

    #userInfo strong {
      color: #ADD8E6; /* Light blue for username */
    }

    #timer {
      margin-bottom: 20px;
      font-size: 1.1em;
      color: #FFA07A; /* Light salmon for timer */
    }

    #questionContainer label {
      display: block;
      margin-bottom: 10px;
      font-size: 1.1em;
      cursor: pointer;
    }

    #questionContainer input[type="radio"] {
      margin-right: 8px;
    }

    /* Styles for action buttons */
    #prevBtn, #nextBtn, #markBtn, #submitBtn {
      padding: 10px 20px;
      margin-top: 20px;
      margin-right: 10px;
      background-color: #007bff; /* Blue for action buttons */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.2s ease;
    }

    #prevBtn:hover, #nextBtn:hover, #markBtn:hover {
      background-color: #0056b3;
    }

    #submitBtn {
      background-color: #dc3545; /* Red for submit button */
    }

    #submitBtn:hover {
      background-color: #c82333;
    }

    /* Styles for the result container */
    #resultContainer {
      background-color: #e0ffe0; /* Light green background from the image */
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
      /* Ensure text color is dark enough for contrast */
      color: #333; /* Dark gray for general text inside the container */
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    #resultContainer h3 {
      color: #006400; /* Darker green for the heading "Quiz Complete!" */
      font-size: 1.5em;
      margin-bottom: 10px;
    }

    #resultContainer p {
      color: #8B0000; /* Dark red for the score line "You scored 0 out of 97." */
      font-weight: bold; /* Make the score line bold */
      font-size: 1.2em;
    }

    #resultContainer strong {
      color: #CC0000; /* Even darker red for the numbers (0 and 97) within the score line */
    }

    /* Styles for subject filter buttons */
    .subject-btn {
      padding: 8px 15px;
      margin-right: 10px;
      margin-bottom: 10px;
      background-color: #6c757d; /* Grey button */
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.2s ease;
    }

    .subject-btn:hover {
      background-color: #5a6268;
    }

    .subject-btn.active {
      background-color: #007bff; /* Active blue button */
      font-weight: bold;
    }
  </style>
</head>
<body class="quiz-page">
  <div class="quiz-layout">
    <div class="quiz-container">
      <h2 id="quizTitle">Quiz</h2>
      <div id="userInfo"><p>Logged in as: <strong>{{ username }}</strong></p></div>
      <div id="timer">Time Left: <span id="timeLeft">1800</span>s</div>

      <div id="subjectFilter" style="margin-bottom: 20px;">
        <h4>Filter by Subject:</h4>
        </div>

      <div id="questionContainer"></div>
      <button id="prevBtn">Previous</button>
      <button id="nextBtn">Next</button>
      <button id="markBtn">Mark for Review</button>
      <button id="submitBtn">Complete Quiz</button>
      <div id="resultContainer" style="display: none;"></div>
    </div>

    <div class="sidebar">
      <h4>Question Navigator</h4>
      <div class="question-grid" id="questionNavigator"></div>
    </div>
  </div>

  <script>
    let allQuestions = []; // Stores all questions fetched from the API
    let filteredQuestions = []; // Stores questions currently displayed based on subject filter
    let currentQuestionIndex = 0;
    let questionStates = []; // To track visited, answered, selected option, and marked status for ALL questions
    let timeLeft = 1800; // 30 minutes
    let timerInterval;
    let currentSubjectFilter = []; // Now an array for multiple selected subjects, or ['All']

    const navContainer = document.getElementById("questionNavigator");
    const questionContainer = document.getElementById("questionContainer");
    const resultContainer = document.getElementById("resultContainer");
    const markBtn = document.getElementById("markBtn");
    const subjectFilterDiv = document.getElementById("subjectFilter");


    async function fetchAndFilterQuestions() {
      const response = await fetch('/api/questions');
      allQuestions = await response.json();

      // Initialize question states for ALL questions
      // This ensures states persist across subject filters
      questionStates = allQuestions.map(q => ({
        visited: false,
        answered: false,
        selected: null, // Stores the index of the selected option (0-3)
        marked: false
      }));

      if (allQuestions.length > 0) {
        populateSubjectFilter(); // Create subject filter buttons

        // Get initial subjects from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const initialSubjects = urlParams.getAll('subject'); // Get all 'subject' params

        if (initialSubjects.length > 0 && !initialSubjects.includes('All')) {
            currentSubjectFilter = initialSubjects;
        } else {
            currentSubjectFilter = ['All']; // Default to 'All' if no specific subjects or 'All' is selected
        }

        applySubjectFilter(); // Apply the filter from URL or default
        startTimer();
      } else {
        questionContainer.innerHTML = "<p>No questions available. Please contact admin.</p>";
        // Hide all buttons if no questions
        document.getElementById("prevBtn").style.display = 'none';
        document.getElementById("nextBtn").style.display = 'none';
        document.getElementById("markBtn").style.display = 'none';
        document.getElementById("submitBtn").style.display = 'none';
      }
    }

    function populateSubjectFilter() {
        const uniqueSubjects = new Set(allQuestions.map(q => q.subject).filter(s => s)); // Get unique non-null subjects
        
        // Clear previous buttons
        subjectFilterDiv.innerHTML = '<h4>Filter by Subject:</h4>';

        // Add "All" button first
        const allBtn = document.createElement("button");
        allBtn.textContent = "All";
        allBtn.classList.add("subject-btn");
        allBtn.addEventListener("click", () => {
            currentSubjectFilter = ['All'];
            applySubjectFilter();
        });
        subjectFilterDiv.appendChild(allBtn);

        // Add buttons for each unique subject
        uniqueSubjects.forEach(subject => {
            const btn = document.createElement("button");
            btn.textContent = subject;
            btn.classList.add("subject-btn");
            btn.addEventListener("click", () => {
                currentSubjectFilter = [subject]; // For single selection, overwrite
                // For multiple selection, you'd add/remove from currentSubjectFilter array
                applySubjectFilter();
            });
            subjectFilterDiv.appendChild(btn);
        });
        // Set active class based on initial filter
        updateSubjectButtonActiveState();
    }

    function updateSubjectButtonActiveState() {
        document.querySelectorAll('.subject-btn').forEach(btn => {
            btn.classList.remove('active');
            if (currentSubjectFilter.includes(btn.textContent) || (currentSubjectFilter.includes('All') && btn.textContent === 'All')) {
                btn.classList.add('active');
            }
        });
    }


    function applySubjectFilter() {
        if (currentSubjectFilter.includes('All')) {
            filteredQuestions = allQuestions;
        } else {
            filteredQuestions = allQuestions.filter(q => currentSubjectFilter.includes(q.subject));
        }

        currentQuestionIndex = 0; // Reset to the first question of the filtered set

        if (filteredQuestions.length > 0) {
            renderQuestion(0);
            document.getElementById("prevBtn").style.display = 'inline-block';
            document.getElementById("nextBtn").style.display = 'inline-block';
            document.getElementById("markBtn").style.display = 'inline-block';
            document.getElementById("submitBtn").style.display = 'inline-block';
        } else {
            questionContainer.innerHTML = `<p>No questions available for selected subjects.</p>`;
            document.getElementById("prevBtn").style.display = 'none';
            document.getElementById("nextBtn").style.display = 'none';
            document.getElementById("markBtn").style.display = 'none';
            document.getElementById("submitBtn").style.display = 'none';
            navContainer.innerHTML = ""; // Clear question navigator
        }
        updateNavButtons(); // Update navigator to reflect filtered questions
        updateSubjectButtonActiveState(); // Ensure active state is correct
    }


    function startTimer() {
        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById("timeLeft").textContent = timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                submitQuiz(); // Auto-submit when time runs out
                alert("Time is up! Your quiz has been submitted automatically.");
            }
        }, 1000);
    }

    function renderQuestion(index) {
      if (index < 0 || index >= filteredQuestions.length) {
        console.error("Invalid filtered question index:", index);
        return;
      }

      currentQuestionIndex = index; // Update current index within the filtered set
      const q = filteredQuestions[index];
      // Find the original index of this question in allQuestions to get its state
      const originalIndex = allQuestions.indexOf(q);

      questionContainer.innerHTML = `
        <p><strong>Question ${index + 1}:</strong> ${q.q}</p>
        <p><strong>Subject:</strong> ${q.subject || 'N/A'}</p>
        ${q.options.map((opt, i) => `
          <label>
            <input type="radio" name="option" value="${i}" ${questionStates[originalIndex].selected == i ? 'checked' : ''}>
            ${opt}
          </label><br/>
        `).join('')}
      `;

      // Update mark button text based on current state
      markBtn.textContent = questionStates[originalIndex].marked ? "Unmark" : "Mark for Review";

      document.getElementsByName("option").forEach(radio => {
        radio.addEventListener("change", (e) => {
          questionStates[originalIndex].answered = true; // Update state of original question
          questionStates[originalIndex].selected = parseInt(e.target.value);
          updateNavButtons(); // Update navigator buttons immediately on answer
        });
      });

      questionStates[originalIndex].visited = true; // Mark as visited
      updateNavButtons(); // Update navigator buttons
    }

    function updateNavButtons() {
      navContainer.innerHTML = "";
      for (let i = 0; i < filteredQuestions.length; i++) {
        const q = filteredQuestions[i];
        // Get the original index to access its state
        const originalIndex = allQuestions.indexOf(q);

        const btn = document.createElement("button");
        btn.classList.add("question-btn");
        if (questionStates[originalIndex].marked) {
          btn.classList.add("marked");
        } else if (questionStates[originalIndex].answered) {
          btn.classList.add("answered");
        } else if (questionStates[originalIndex].visited) {
          btn.classList.add("visited");
        }

        if (i === currentQuestionIndex) {
          btn.classList.add("current");
        }
        btn.textContent = i + 1;
        btn.addEventListener("click", () => {
          renderQuestion(i); // Render the clicked question (from filtered list)
        });
        navContainer.appendChild(btn);
      }
    }

    document.getElementById("nextBtn").addEventListener("click", () => {
      if (currentQuestionIndex < filteredQuestions.length - 1) {
        renderQuestion(currentQuestionIndex + 1);
      }
    });

    document.getElementById("prevBtn").addEventListener("click", () => {
      if (currentQuestionIndex > 0) {
        renderQuestion(currentQuestionIndex - 1);
      }
    });

    markBtn.addEventListener("click", () => {
      // Find the original index of the current question in allQuestions
      const q = filteredQuestions[currentQuestionIndex];
      const originalIndex = allQuestions.indexOf(q);

      const state = questionStates[originalIndex];
      state.marked = !state.marked;
      markBtn.textContent = state.marked ? "Unmark" : "Mark for Review";
      updateNavButtons();
    });

    document.getElementById("submitBtn").addEventListener("click", () => {
        submitQuiz();
    });

    function submitQuiz() {
        clearInterval(timerInterval); // Stop the timer

        let correctCount = 0;
        allQuestions.forEach((q, i) => { // Calculate score based on ALL questions, not just filtered
            if (questionStates[i].selected === q.answer) {
                correctCount++;
            }
        });

        // Hide quiz elements
        questionContainer.style.display = 'none';
        document.getElementById("nextBtn").style.display = 'none';
        document.getElementById("prevBtn").style.display = 'none';
        document.getElementById("submitBtn").style.display = 'none';
        markBtn.style.display = 'none';
        document.getElementById("timer").style.display = 'none'; // Hide timer too
        document.getElementById("quizTitle").textContent = 'Quiz Results'; // Update title
        document.getElementById("userInfo").style.display = 'none'; // Hide user info
        document.getElementById("subjectFilter").style.display = 'none'; // Hide subject filter

        // Show results
        resultContainer.style.display = 'block';
        resultContainer.innerHTML = `<h3>Quiz Complete!</h3><p>You scored <strong>${correctCount}</strong> out of <strong>${allQuestions.length}</strong>.</p>`;

        // Optionally, disable question navigator buttons or change their appearance
        navContainer.querySelectorAll('.question-btn').forEach(btn => {
            btn.disabled = true;
            btn.style.opacity = 0.6;
            btn.style.cursor = 'not-allowed';
        });
    }

    // Fetch questions when the page loads
    fetchAndFilterQuestions(); // Renamed to reflect initial filtering
  </script>
</body>
</html>